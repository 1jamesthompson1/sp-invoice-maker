<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Invoice Maker - Client Management</title>

    <!-- CSS must be inlined -->
    <style>
      * {
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        padding: 20px;
        background: #f5f5f5;
        margin: 0;
      }

      h1 {
        color: #333;
        margin-bottom: 24px;
      }

      h2 {
        color: #555;
        margin-top: 32px;
        margin-bottom: 16px;
        font-size: 1.3em;
      }

      .tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 24px;
        border-bottom: 2px solid #ddd;
      }

      .tab {
        background: transparent;
        border: none;
        padding: 12px 24px;
        cursor: pointer;
        font-size: 14px;
        color: #666;
        border-bottom: 3px solid transparent;
        margin-bottom: -2px;
        transition: all 0.2s;
      }

      .tab:hover {
        color: #333;
        background: #f0f0f0;
      }

      .tab.active {
        color: #4caf50;
        border-bottom-color: #4caf50;
        font-weight: 600;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .card {
        background: white;
        border-radius: 8px;
        padding: 24px;
        margin-bottom: 16px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
      }

      .form-group {
        margin-bottom: 16px;
      }

      label {
        display: block;
        margin-bottom: 6px;
        color: #555;
        font-weight: 500;
        font-size: 14px;
      }

      input[type="text"],
      input[type="number"],
      input[type="email"],
      textarea,
      select {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        font-family: inherit;
        transition: border-color 0.2s;
      }

      input:focus,
      textarea:focus,
      select:focus {
        outline: none;
        border-color: #4caf50;
      }

      textarea {
        resize: vertical;
        min-height: 80px;
      }

      .checkbox-group {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
      }

      button {
        background: #4caf50;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: background 0.2s;
      }

      button:hover {
        background: #45a049;
      }

      button.secondary {
        background: #757575;
      }

      button.secondary:hover {
        background: #616161;
      }

      button.danger {
        background: #f44336;
      }

      button.danger:hover {
        background: #d32f2f;
      }

      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      .button-group {
        display: flex;
        gap: 8px;
        margin-top: 16px;
      }

      .client-list {
        display: grid;
        gap: 12px;
      }

      .client-item {
        background: white;
        border-radius: 8px;
        padding: 16px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: start;
      }

      .client-info {
        flex: 1;
      }

      .client-name {
        font-weight: 600;
        font-size: 16px;
        color: #333;
        margin-bottom: 8px;
      }

      .client-details {
        font-size: 13px;
        color: #666;
        line-height: 1.5;
      }

      .client-actions {
        display: flex;
        gap: 8px;
      }

      .client-actions button {
        padding: 6px 12px;
        font-size: 13px;
      }

      .project-list {
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid #eee;
      }

      .project-item {
        padding: 8px;
        background: #f5f5f5;
        border-radius: 4px;
        margin-bottom: 8px;
        font-size: 13px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .badge {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 500;
        background: #e8f5e9;
        color: #2e7d32;
        margin-left: 8px;
      }

      .badge.warning {
        background: #fff3e0;
        color: #ef6c00;
      }

      .empty-state {
        text-align: center;
        padding: 40px;
        color: #999;
      }

      .small-text {
        font-size: 12px;
        color: #888;
        margin-top: 4px;
      }

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
      }
    </style>
  </head>
  <body>
    <h1>üìÑ Invoice Maker</h1>

    <div class="tabs">
      <button class="tab active" data-tab="generate">Generate Invoice</button>
      <button class="tab" data-tab="invoices">Invoices</button>
      <button class="tab" data-tab="mydetails">My Details</button>
      <button class="tab" data-tab="clients">Clients</button>
      <button class="tab" data-tab="projects">Project Assignment</button>
    </div>

    <!-- My Details Tab -->
    <div class="tab-content" id="mydetails-tab">
      <div class="card">
        <h2>Your Business Information</h2>
        <p style="color: #666; margin-bottom: 20px;">This information will appear on your invoices.</p>
        
        <form id="mydetails-form">
          <div class="form-group">
            <label>Business/Your Name *</label>
            <input type="text" id="my-name" required placeholder="e.g., John Smith Consulting">
          </div>

          <div class="form-group">
            <label>Email</label>
            <input type="email" id="my-email" placeholder="your@email.com">
          </div>

          <div class="form-group">
            <label>Phone</label>
            <input type="text" id="my-phone" placeholder="+1 234 567 8900">
          </div>

          <div class="form-group">
            <label>Business Address</label>
            <textarea id="my-address" placeholder="Street, City, Postal Code, Country"></textarea>
          </div>

          <div class="form-group">
            <label>Website</label>
            <input type="text" id="my-website" placeholder="https://yourwebsite.com">
          </div>

          <div class="form-group">
            <label>Tax ID Label (optional)</label>
            <input type="text" id="my-tax-id-label" placeholder="e.g., Tax ID, GST Number, ABN">
            <div class="small-text">What to call your Tax ID on invoices</div>
          </div>

          <div class="form-group">
            <label>Tax ID / Business Number (optional)</label>
            <input type="text" id="my-tax-id" placeholder="e.g., ABN, EIN, VAT Number">
          </div>

          <div class="form-group">
            <label>Bank Details (optional)</label>
            <textarea id="my-bank" placeholder="Bank name, Account number, Routing number, etc."></textarea>
            <div class="small-text">This will appear on invoices for client payments</div>
          </div>

          <h3 style="color: #555; margin-top: 32px; margin-bottom: 16px;">Invoice Template Settings</h3>

          <div class="form-group">
            <label>Invoice Title (optional)</label>
            <input type="text" id="my-invoice-title" placeholder="e.g., Invoice" value="Invoice">
            <div class="small-text">The title shown at the top of your invoices</div>
          </div>

          <div class="form-group">
            <label>Invoice End Message (optional)</label>
            <textarea id="my-invoice-message" placeholder="e.g., Thank you for your business!" style="min-height: 60px;"></textarea>
            <div class="small-text">Custom message that appears at the end of your invoices</div>
          </div>

          <button type="submit">Save My Details</button>
        </form>
      </div>

      <div id="mydetails-preview" style="display: none;">
        <h2>Preview</h2>
        <div class="card">
          <div id="preview-content"></div>
        </div>
      </div>
    </div>

    <!-- Clients Tab -->
    <div class="tab-content" id="clients-tab">
      <div class="card">
        <h2>Add New Client</h2>
        <form id="client-form">
          <div class="form-group">
            <label>Client Name *</label>
            <input type="text" id="client-name" required placeholder="e.g., Acme Corporation">
          </div>

          <div class="form-group">
            <label>Email</label>
            <input type="email" id="client-email" placeholder="client@example.com">
          </div>

          <div class="form-group">
            <label>Billing Address</label>
            <textarea id="client-address" placeholder="Street, City, Postal Code, Country"></textarea>
          </div>

          <div class="form-group">
            <label>Hourly Rate ($/hr) *</label>
            <input type="number" id="client-rate" required min="0" step="0.01" placeholder="e.g., 75.00">
          </div>

          <div class="form-group">
            <label>Tax Name (e.g., GST, VAT)</label>
            <input type="text" id="client-tax-name" placeholder="e.g., GST">
          </div>

          <div class="form-group">
            <label>Tax Rate (%)</label>
            <input type="number" id="client-tax-rate" min="0" max="100" step="0.01" placeholder="e.g., 15">
          </div>

          <div class="form-group">
            <div class="checkbox-group">
              <input type="checkbox" id="client-tax-enabled">
              <label for="client-tax-enabled" style="margin-bottom: 0;">Apply tax to invoices</label>
            </div>
          </div>

          <div class="button-group">
            <button type="submit">Save Client</button>
            <button type="button" class="secondary" id="cancel-edit">Cancel</button>
          </div>
        </form>
      </div>

      <h2>Your Clients</h2>
      <div id="clients-list" class="client-list">
        <div class="empty-state">No clients yet. Add your first client above!</div>
      </div>
    </div>

    <!-- Project Assignment Tab -->
    <div class="tab-content" id="projects-tab">
      <div class="card">
        <h2>Assign Projects to Clients</h2>
        <p style="color: #666; margin-bottom: 20px;">Link your Super Productivity projects to clients for invoice generation.</p>
        
        <div class="form-group">
          <label>Select Project *</label>
          <select id="project-select">
            <option value="">-- Select a project --</option>
          </select>
        </div>

        <div class="form-group">
          <label>Assign to Client *</label>
          <select id="client-select">
            <option value="">-- Select a client --</option>
          </select>
        </div>

        <button id="assign-project">Assign Project</button>
      </div>

      <h2>Project Assignments</h2>
      <div id="assignments-list">
        <div class="empty-state">No project assignments yet.</div>
      </div>
    </div>

    <!-- Generate Invoice Tab -->
    <div class="tab-content active" id="generate-tab">
      <div class="card">
        <h2>Generate Invoice</h2>
        <p style="color: #666; margin-bottom: 20px;">Create and preview an invoice for a client.</p>
        
        <form id="generate-invoice-form">
          <div class="form-group">
            <label>Select Client *</label>
            <select id="gen-client-select" required>
              <option value="">-- Select a client --</option>
            </select>
          </div>

          <div class="form-group">
            <label>Invoice Date *</label>
            <input type="date" id="gen-invoice-date" required>
          </div>

          <div class="form-group">
            <label>Period *</label>
            <select id="gen-period-select" required>
              <option value="week">This Week</option>
              <option value="month" selected>This Month</option>
              <option value="last-month">Last Month</option>
              <option value="year">This Year</option>
              <option value="custom-days">Last N Days</option>
              <option value="custom-range">Custom Date Range</option>
            </select>
          </div>

          <div class="form-group" id="gen-custom-days-group" style="display: none;">
            <label>Days Back *</label>
            <input type="number" id="gen-custom-days" min="1" value="30">
          </div>

          <div class="form-group" id="gen-custom-range-group" style="display: none;">
            <label>Start Date *</label>
            <input type="date" id="gen-start-date">
            <label style="margin-top: 16px;">End Date *</label>
            <input type="date" id="gen-end-date">
          </div>

          <div class="form-group">
            <label>Itemization *</label>
            <select id="gen-itemization-select" required>
              <option value="1">Project Only (Single Line)</option>
              <option value="2" selected>Show Main Tasks</option>
            </select>
          </div>

          <button type="submit">Generate Invoice</button>
        </form>
      </div>

      <div id="invoice-preview" style="display: none; margin-top: 20px;">
        <h2>Invoice Preview</h2>
        <div id="invoice-iframe-container"></div>
      </div>
    </div>

    <!-- Invoices Tab -->
    <div class="tab-content" id="invoices-tab">
      <div class="card">
        <h2>Generated Invoices</h2>
        <p style="color: #666; margin-bottom: 20px;">View all invoices you have generated.</p>
      </div>

      <div id="invoices-list">
        <div class="empty-state">No invoices generated yet.</div>
      </div>
    </div>

    <!-- JavaScript must be inlined -->
    <script>
      // State management
      let myDetails = null;
      let clients = [];
      let projectAssignments = {};
      let projects = [];
      let editingClientId = null;
      let generatedInvoices = []; // Store generated invoices with their numbers
      let lastPersistAt = 0;
      let pendingInvoiceData = null;
      let hasPendingInvoiceSaved = false;

      // Initialize
      async function init() {
        await loadData();
        await loadProjects();
        
        // Set default values if needed
        if (!myDetails) {
          myDetails = {};
        }
        if (!myDetails.invoiceTitle) {
          myDetails.invoiceTitle = 'Invoice';
        }
        if (!myDetails.invoiceMessage) {
          myDetails.invoiceMessage = 'Thank you for your business!';
        }
        if (!myDetails.taxIdLabel) {
          myDetails.taxIdLabel = 'Tax ID';
        }
        
        renderMyDetails();
        renderClients();
        renderProjectAssignments();
        updateProjectSelect();
        updateClientSelect();
        updateGenerateClientSelect();
          renderInvoices();
        setDefaultInvoiceDate();
        setupPrintShortcut();
      }

      async function finalizeInvoiceSave() {
        if (!pendingInvoiceData || hasPendingInvoiceSaved) return;
        if (generatedInvoices.some(inv => inv.number === pendingInvoiceData.number)) {
          hasPendingInvoiceSaved = true;
          return;
        }

        generatedInvoices.push(pendingInvoiceData);
        await saveData();
        renderInvoices();
        hasPendingInvoiceSaved = true;
      }
          // Render all generated invoices in the Invoices tab
          function renderInvoices() {
            const invoicesList = document.getElementById('invoices-list');
            if (!invoicesList) return;

            if (generatedInvoices.length === 0) {
              invoicesList.innerHTML = '<p style="padding: 10px; color: #666;">No invoices generated yet.</p>';
              return;
            }

            const html = `
              <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                <thead>
                  <tr style="background-color: #f5f5f5; border-bottom: 2px solid #ddd;">
                    <th style="padding: 10px; text-align: left;">Invoice #</th>
                    <th style="padding: 10px; text-align: left;">Client</th>
                    <th style="padding: 10px; text-align: left;">Date</th>
                    <th style="padding: 10px; text-align: left;">Period</th>
                    <th style="padding: 10px; text-align: right;">Total</th>
                    <th style="padding: 10px; text-align: left;">Created</th>
                    <th style="padding: 10px; text-align: center;">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  ${generatedInvoices.map((invoice, index) => {
                    const createdDate = new Date(invoice.createdAt).toLocaleDateString();
                    return `
                      <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 10px; font-weight: bold;">${invoice.number}</td>
                        <td style="padding: 10px;">${invoice.clientName}</td>
                        <td style="padding: 10px;">${new Date(invoice.date).toLocaleDateString()}</td>
                        <td style="padding: 10px; font-size: 0.9em;">${invoice.period}</td>
                        <td style="padding: 10px; text-align: right; font-weight: bold;">$${invoice.total.toFixed(2)}</td>
                        <td style="padding: 10px; font-size: 0.9em;">${createdDate}</td>
                        <td style="padding: 10px; text-align: center;">
                          <button onclick="deleteInvoice(${index})" style="padding: 5px 10px; background-color: #ff6b6b; color: white; border: none; border-radius: 4px; cursor: pointer;">Delete</button>
                        </td>
                      </tr>
                    `;
                  }).join('')}
                </tbody>
              </table>
            `;
            invoicesList.innerHTML = html;
          }

          window.deleteInvoice = function(index) {
            if (confirm('Are you sure you want to delete this invoice?')) {
              generatedInvoices.splice(index, 1);
              saveData();
              renderInvoices();
              PluginAPI.showSnack({ msg: 'Invoice deleted', type: 'SUCCESS' });
            }
          };


      // Load data from storage
        // Generate unique invoice number
        function generateInvoiceNumber() {
          const now = new Date();
          const year = now.getFullYear();
          const month = String(now.getMonth() + 1).padStart(2, '0');
          const prefix = `INV-${year}${month}-`;

          const existingNumbers = new Set(
            generatedInvoices
              .map(inv => inv.number)
              .filter(number => number && number.startsWith(prefix))
          );

          const max = 99999;
          const min = 0;
          const getRandomInt = () => {
            if (window.crypto && window.crypto.getRandomValues) {
              const buffer = new Uint32Array(1);
              window.crypto.getRandomValues(buffer);
              return min + (buffer[0] % (max - min + 1));
            }
            return Math.floor(Math.random() * (max - min + 1)) + min;
          };

          for (let attempt = 0; attempt < 20; attempt += 1) {
            const randomPart = String(getRandomInt()).padStart(5, '0');
            const candidate = `${prefix}${randomPart}`;
            if (!existingNumbers.has(candidate)) {
              return candidate;
            }
          }

          return `${prefix}${String(Date.now()).slice(-5)}`;
        }

        function setupPrintShortcut() {
          window.addEventListener('keydown', (event) => {
            const isPrint = (event.ctrlKey || event.metaKey) && event.key.toLowerCase() === 'p';
            if (!isPrint) return;

            const iframe = document.querySelector('#invoice-iframe-container iframe');
            if (!iframe || !iframe.contentWindow) return;

            event.preventDefault();
            finalizeInvoiceSave();
            iframe.contentWindow.focus();
            iframe.contentWindow.print();
          });
        }

      async function loadData() {
        try {
          const data = await PluginAPI.loadSyncedData();
          if (data) {
            const parsed = JSON.parse(data);
            myDetails = parsed.myDetails || null;
            clients = parsed.clients || [];
            projectAssignments = parsed.projectAssignments || {};
            generatedInvoices = parsed.generatedInvoices || [];
          }
        } catch (error) {
          console.error('Error loading data:', error);
        }
      }

      // Save data to storage
      async function saveData() {
        try {
          const now = Date.now();
          const elapsed = now - lastPersistAt;
          if (elapsed < 1000) {
            await new Promise(resolve => setTimeout(resolve, 1000 - elapsed));
          }
          const data = JSON.stringify({
            myDetails: myDetails,
            clients: clients,
            projectAssignments: projectAssignments,
            generatedInvoices: generatedInvoices
          });
          await PluginAPI.persistDataSynced(data);
          lastPersistAt = Date.now();
        } catch (error) {
          console.error('Error saving data:', error);
          PluginAPI.showSnack({
            msg: 'Error saving data',
            type: 'ERROR'
          });
        }
      }

      // Load projects from Super Productivity
      async function loadProjects() {
        try {
          projects = await PluginAPI.getAllProjects();
        } catch (error) {
          console.error('Error loading projects:', error);
          PluginAPI.showSnack({
            msg: 'Error loading projects',
            type: 'ERROR'
          });
        }
      }

      // My Details form submission
      document.getElementById('mydetails-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        myDetails = {
          name: document.getElementById('my-name').value,
          email: document.getElementById('my-email').value,
          phone: document.getElementById('my-phone').value,
          address: document.getElementById('my-address').value,
          website: document.getElementById('my-website').value,
          taxIdLabel: document.getElementById('my-tax-id-label').value || 'Tax ID',
          taxId: document.getElementById('my-tax-id').value,
          bankDetails: document.getElementById('my-bank').value,
          invoiceTitle: document.getElementById('my-invoice-title').value || 'Invoice',
          invoiceMessage: document.getElementById('my-invoice-message').value || 'Thank you for your business!'
        };

        await saveData();
        renderMyDetails();

        PluginAPI.showSnack({
          msg: 'Your details saved successfully',
          type: 'SUCCESS'
        });
      });

      // Render my details
      function renderMyDetails() {
        if (myDetails && myDetails.name) {
          // Populate form
          document.getElementById('my-name').value = myDetails.name || '';
          document.getElementById('my-email').value = myDetails.email || '';
          document.getElementById('my-phone').value = myDetails.phone || '';
          document.getElementById('my-address').value = myDetails.address || '';
          document.getElementById('my-website').value = myDetails.website || '';
          document.getElementById('my-tax-id-label').value = myDetails.taxIdLabel || 'Tax ID';
          document.getElementById('my-tax-id').value = myDetails.taxId || '';
          document.getElementById('my-bank').value = myDetails.bankDetails || '';
          document.getElementById('my-invoice-title').value = myDetails.invoiceTitle || 'Invoice';
          document.getElementById('my-invoice-message').value = myDetails.invoiceMessage || 'Thank you for your business!';

          // Show preview
          document.getElementById('mydetails-preview').style.display = 'block';
          const preview = document.getElementById('preview-content');
          preview.innerHTML = `
            <strong style="font-size: 18px; color: #333;">${escapeHtml(myDetails.name)}</strong><br>
            ${myDetails.email ? `üìß ${escapeHtml(myDetails.email)}<br>` : ''}
            ${myDetails.phone ? `üìû ${escapeHtml(myDetails.phone)}<br>` : ''}
            ${myDetails.address ? `<div style="margin-top: 8px; white-space: pre-line;">${escapeHtml(myDetails.address)}</div>` : ''}
            ${myDetails.website ? `<div style="margin-top: 8px;">üåê ${escapeHtml(myDetails.website)}</div>` : ''}
            ${myDetails.taxId ? `<div style="margin-top: 8px;"><strong>${escapeHtml(myDetails.taxIdLabel || 'Tax ID')}:</strong> ${escapeHtml(myDetails.taxId)}</div>` : ''}
            ${myDetails.bankDetails ? `<div style="margin-top: 8px;"><strong>Bank Details:</strong><br><span style="white-space: pre-line;">${escapeHtml(myDetails.bankDetails)}</span></div>` : ''}
            ${myDetails.invoiceTitle ? `<div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #eee;"><strong>Invoice Title:</strong> ${escapeHtml(myDetails.invoiceTitle)}</div>` : ''}
            ${myDetails.invoiceMessage ? `<div style="margin-top: 8px;"><strong>Invoice Message:</strong> ${escapeHtml(myDetails.invoiceMessage)}</div>` : ''}
          `;
        }
      }

      // Tab switching
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          const tabName = tab.dataset.tab;
          
          // Update tab buttons
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          
          // Update tab content
          document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
          });
          document.getElementById(`${tabName}-tab`).classList.add('active');
        });
      });

      // Client form submission
      document.getElementById('client-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const client = {
          id: editingClientId || Date.now().toString(),
          name: document.getElementById('client-name').value,
          email: document.getElementById('client-email').value,
          address: document.getElementById('client-address').value,
          hourlyRate: parseFloat(document.getElementById('client-rate').value),
          taxName: document.getElementById('client-tax-name').value || 'Tax',
          taxRate: parseFloat(document.getElementById('client-tax-rate').value) || 0,
          taxEnabled: document.getElementById('client-tax-enabled').checked
        };

        if (editingClientId) {
          // Update existing client
          const index = clients.findIndex(c => c.id === editingClientId);
          clients[index] = client;
          PluginAPI.showSnack({
            msg: 'Client updated successfully',
            type: 'SUCCESS'
          });
        } else {
          // Add new client
          clients.push(client);
          PluginAPI.showSnack({
            msg: 'Client added successfully',
            type: 'SUCCESS'
          });
        }

        await saveData();
        resetForm();
        renderClients();
        updateClientSelect();
        updateGenerateClientSelect();
      });

      // Cancel edit button
      document.getElementById('cancel-edit').addEventListener('click', () => {
        resetForm();
      });

      // Reset form
      function resetForm() {
        editingClientId = null;
        document.getElementById('client-form').reset();
        document.querySelector('#client-form button[type="submit"]').textContent = 'Save Client';
      }

      // Edit client
      function editClient(clientId) {
        const client = clients.find(c => c.id === clientId);
        if (!client) return;

        editingClientId = clientId;
        document.getElementById('client-name').value = client.name;
        document.getElementById('client-email').value = client.email || '';
        document.getElementById('client-address').value = client.address || '';
        document.getElementById('client-rate').value = client.hourlyRate;
        document.getElementById('client-tax-name').value = client.taxName || '';
        document.getElementById('client-tax-rate').value = client.taxRate || 0;
        document.getElementById('client-tax-enabled').checked = client.taxEnabled;

        document.querySelector('#client-form button[type="submit"]').textContent = 'Update Client';
        
        // Scroll to form
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      // Delete client
      async function deleteClient(clientId) {
        const confirmed = await PluginAPI.openDialog({
          title: 'Delete Client',
          content: 'Are you sure you want to delete this client? Project assignments will be removed.',
          okBtnLabel: 'Delete',
          cancelBtnLabel: 'Cancel'
        });

        if (confirmed) {
          clients = clients.filter(c => c.id !== clientId);
          
          // Remove project assignments
          for (const projectId in projectAssignments) {
            if (projectAssignments[projectId] === clientId) {
              delete projectAssignments[projectId];
            }
          }

          await saveData();
          renderClients();
          renderProjectAssignments();
          updateClientSelect();
          updateGenerateClientSelect();

          PluginAPI.showSnack({
            msg: 'Client deleted',
            type: 'SUCCESS'
          });
        }
      }

      // Render clients list
      function renderClients() {
        const container = document.getElementById('clients-list');
        
        if (clients.length === 0) {
          container.innerHTML = '<div class="empty-state">No clients yet. Add your first client above!</div>';
          return;
        }

        container.innerHTML = clients.map(client => {
          const assignedProjects = Object.entries(projectAssignments)
            .filter(([_, clientId]) => clientId === client.id)
            .map(([projectId, _]) => projects.find(p => p.id === projectId))
            .filter(p => p);

          return `
            <div class="client-item">
              <div class="client-info">
                <div class="client-name">${escapeHtml(client.name)}</div>
                <div class="client-details">
                  ${client.email ? `üìß ${escapeHtml(client.email)}<br>` : ''}
                  üíµ $${client.hourlyRate.toFixed(2)}/hr
                  ${client.taxEnabled ? `<span class="badge">+${client.taxRate}% ${escapeHtml(client.taxName)}</span>` : ''}
                  <div class="small-text">${assignedProjects.length} project(s) assigned</div>
                </div>
              </div>
              <div class="client-actions">
                <button class="secondary" onclick="editClient('${client.id}')">Edit</button>
                <button class="danger" onclick="deleteClient('${client.id}')">Delete</button>
              </div>
            </div>
          `;
        }).join('');
      }

      // Update project select dropdown
      function updateProjectSelect() {
        const select = document.getElementById('project-select');
        select.innerHTML = '<option value="">-- Select a project --</option>';
        
        projects.forEach(project => {
          const option = document.createElement('option');
          option.value = project.id;
          option.textContent = project.title;
          select.appendChild(option);
        });
      }

      // Update client select dropdown
      function updateClientSelect() {
        const select = document.getElementById('client-select');
        select.innerHTML = '<option value="">-- Select a client --</option>';
        
        clients.forEach(client => {
          const option = document.createElement('option');
          option.value = client.id;
          option.textContent = client.name;
          select.appendChild(option);
        });
      }

      // Assign project to client
      document.getElementById('assign-project').addEventListener('click', async () => {
        const projectId = document.getElementById('project-select').value;
        const clientId = document.getElementById('client-select').value;

        if (!projectId || !clientId) {
          PluginAPI.showSnack({
            msg: 'Please select both a project and a client',
            type: 'WARNING'
          });
          return;
        }

        projectAssignments[projectId] = clientId;
        await saveData();
        
        document.getElementById('project-select').value = '';
        document.getElementById('client-select').value = '';

        renderProjectAssignments();
        renderClients();

        PluginAPI.showSnack({
          msg: 'Project assigned successfully',
          type: 'SUCCESS'
        });
      });

      // Remove project assignment
      async function removeAssignment(projectId) {
        delete projectAssignments[projectId];
        await saveData();
        renderProjectAssignments();
        renderClients();

        PluginAPI.showSnack({
          msg: 'Assignment removed',
          type: 'SUCCESS'
        });
      }

      // Render project assignments
      function renderProjectAssignments() {
        const container = document.getElementById('assignments-list');
        
        const assignments = Object.entries(projectAssignments)
          .map(([projectId, clientId]) => {
            const project = projects.find(p => p.id === projectId);
            const client = clients.find(c => c.id === clientId);
            return { project, client, projectId };
          })
          .filter(a => a.project && a.client);

        if (assignments.length === 0) {
          container.innerHTML = '<div class="empty-state">No project assignments yet.</div>';
          return;
        }

        container.innerHTML = assignments.map(({ project, client, projectId }) => `
          <div class="client-item">
            <div class="client-info">
              <div class="client-name">${escapeHtml(project.title)}</div>
              <div class="client-details">
                ‚Üí Assigned to <strong>${escapeHtml(client.name)}</strong> ($${client.hourlyRate.toFixed(2)}/hr)
              </div>
            </div>
            <div class="client-actions">
              <button class="danger" onclick="removeAssignment('${projectId}')">Remove</button>
            </div>
          </div>
        `).join('');
      }

      // Utility: escape HTML
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // Update generate client select
      function updateGenerateClientSelect() {
        const select = document.getElementById('gen-client-select');
        select.innerHTML = '<option value="">-- Select a client --</option>';
        
        clients.forEach(client => {
          const option = document.createElement('option');
          option.value = client.id;
          option.textContent = client.name;
          select.appendChild(option);
        });
      }

      // Handle period select change
      document.getElementById('gen-period-select').addEventListener('change', (e) => {
        const customDaysGroup = document.getElementById('gen-custom-days-group');
        const customRangeGroup = document.getElementById('gen-custom-range-group');
        
        customDaysGroup.style.display = e.target.value === 'custom-days' ? 'block' : 'none';
        customRangeGroup.style.display = e.target.value === 'custom-range' ? 'block' : 'none';
      });

      // Set today's date as default
      function setDefaultInvoiceDate() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('gen-invoice-date').value = today;
      }

      // Generate invoice form submission
      document.getElementById('generate-invoice-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        try {
          const selectedClientId = document.getElementById('gen-client-select').value;
          const invoiceDate = document.getElementById('gen-invoice-date').value;
          const periodType = document.getElementById('gen-period-select').value;
          const itemizationLevel = parseInt(document.getElementById('gen-itemization-select').value);

          if (!selectedClientId) {
            PluginAPI.showSnack({
              msg: 'Please select a client',
              type: 'WARNING'
            });
            return;
          }

          const selectedClient = clients.find(c => c.id === selectedClientId);
          
          // Find projects assigned to this client
          const clientProjects = Object.entries(projectAssignments)
            .filter(([_, clientId]) => clientId === selectedClientId)
            .map(([projectId, _]) => projectId);

          if (clientProjects.length === 0) {
            PluginAPI.showSnack({
              msg: 'This client has no projects assigned',
              type: 'WARNING'
            });
            return;
          }

          // Get all tasks and projects
          const tasks = await PluginAPI.getTasks();
          const archivedTasks = await PluginAPI.getArchivedTasks();
          const allTasks = [...tasks, ...archivedTasks];

          // Calculate cutoff date
          let cutoffDate = new Date();
          let endDate = new Date();
          let periodLabel = '';

          switch (periodType) {
            case 'week': {
              const today = new Date();
              cutoffDate.setDate(today.getDate() - today.getDay());
              const weekNumber = Math.ceil((today - new Date(today.getFullYear(), 0, 1)) / (7 * 24 * 60 * 60 * 1000));
              periodLabel = `Week ${weekNumber}`;
              break;
            }
            case 'year': {
              const year = new Date().getFullYear();
              cutoffDate = new Date(year, 0, 1);
              periodLabel = `${year}`;
              break;
            }
            case 'last-month': {
              const today = new Date();
              const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                                 'July', 'August', 'September', 'October', 'November', 'December'];
              const lastMonth = today.getMonth() === 0 ? 11 : today.getMonth() - 1;
              const lastMonthYear = today.getMonth() === 0 ? today.getFullYear() - 1 : today.getFullYear();
              cutoffDate = new Date(lastMonthYear, lastMonth, 1);
              endDate = new Date(lastMonthYear, lastMonth + 1, 0, 23, 59, 59);
              periodLabel = `${monthNames[lastMonth]} ${lastMonthYear}`;
              break;
            }
            case 'custom-days': {
              const daysBack = parseInt(document.getElementById('gen-custom-days').value) || 30;
              cutoffDate.setDate(cutoffDate.getDate() - daysBack);
              periodLabel = `Last ${daysBack} days`;
              break;
            }
            case 'custom-range': {
              const startDateStr = document.getElementById('gen-start-date').value;
              const endDateStr = document.getElementById('gen-end-date').value;
              
              if (!startDateStr || !endDateStr) {
                PluginAPI.showSnack({
                  msg: 'Please enter both start and end dates for custom range',
                  type: 'WARNING'
                });
                return;
              }
              
              cutoffDate = new Date(startDateStr);
              endDate = new Date(endDateStr);
              endDate.setHours(23, 59, 59);
              periodLabel = `${startDateStr} to ${endDateStr}`;
              break;
            }
            case 'month':
            default: {
              const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                                 'July', 'August', 'September', 'October', 'November', 'December'];
              const today = new Date();
              cutoffDate = new Date(today.getFullYear(), today.getMonth(), 1);
              periodLabel = `${monthNames[today.getMonth()]} ${today.getFullYear()}`;
            }
          }

          // Calculate hours for client projects
          const projectHours = {};
          const projectTasks = {};

          allTasks.forEach(task => {
            if (task.timeSpent && task.timeSpent > 0 && clientProjects.includes(task.projectId)) {
              const taskDate = new Date(task.changed || task.created);
              if (taskDate >= cutoffDate && taskDate <= endDate) {
                const hours = task.timeSpent / (1000 * 60 * 60);
                if (!projectHours[task.projectId]) {
                  projectHours[task.projectId] = 0;
                  projectTasks[task.projectId] = [];
                }
                projectHours[task.projectId] += hours;
                
                // Only include parent tasks (tasks without parentId)
                if (!task.parentId) {
                  projectTasks[task.projectId].push({
                    id: task.id,
                    title: task.title,
                    hours: hours
                  });
                }
              }
            }
          });

          if (Object.keys(projectHours).length === 0) {
            PluginAPI.showSnack({
              msg: `No time tracked for this client in the selected period`,
              type: 'WARNING'
            });
            return;
          }

          // Generate invoice HTML using the plugin's function
          // For now, we'll create a simple preview
          displayInvoicePreview(myDetails, selectedClient, projects, projectHours, projectTasks, invoiceDate, periodLabel, itemizationLevel);

        } catch (error) {
          console.error('Error generating invoice:', error);
          PluginAPI.showSnack({
            msg: 'Error generating invoice: ' + error.message,
            type: 'ERROR'
          });
        }
      });

      // Display invoice preview
      async function displayInvoicePreview(myDetails, client, projectsList, projectHours, projectTasks, invoiceDate, periodLabel, itemizationLevel) {
        const projectMap = {};
        projectsList.forEach(p => {
          projectMap[p.id] = p.title;
        });

        let totalHours = 0;
        let subtotal = 0;
        // Generate unique invoice number
        const invoiceNumber = generateInvoiceNumber();
        const myEmailLink = myDetails.email ? `mailto:${myDetails.email}` : '';
        const clientEmailLink = client.email ? `mailto:${client.email}` : '';
        const websiteUrl = myDetails.website
          ? (myDetails.website.startsWith('http') ? myDetails.website : `https://${myDetails.website}`)
          : '';

        const lineItems = Object.entries(projectHours).map(([projectId, hours]) => {
          const projectName = projectMap[projectId] || 'Unknown Project';
          const amount = hours * client.hourlyRate;
          totalHours += hours;
          subtotal += amount;

          let descriptionContent = `<div style="font-weight: 600;">${projectName}</div>`;
          
          if (itemizationLevel === 2 && projectTasks[projectId] && projectTasks[projectId].length > 0) {
            const taskList = projectTasks[projectId].map(t => 
              `<div style="font-size: 12px; color: #666; padding: 2px 0; padding-left: 20px;">‚Ä¢ ${t.title} (${t.hours.toFixed(2)}h)</div>`
            ).join('\n');
            descriptionContent += taskList;
          }

          return `
            <tr>
              <td style="padding: 12px 8px; border-bottom: 1px solid #eee;">
                ${descriptionContent}
              </td>
              <td style="padding: 12px 8px; border-bottom: 1px solid #eee; text-align: right;">${hours.toFixed(2)}</td>
              <td style="padding: 12px 8px; border-bottom: 1px solid #eee; text-align: right;">$${client.hourlyRate.toFixed(2)}</td>
              <td style="padding: 12px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: 600;">$${amount.toFixed(2)}</td>
            </tr>`;
        }).join('\n');

        const taxAmount = client.taxEnabled ? (subtotal * client.taxRate / 100) : 0;
        const total = subtotal + taxAmount;

        const invoiceHTML = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Invoice ${invoiceNumber}</title>
  <style>
    @media print {
      body { margin: 0; }
      .no-print { display: none; }
    }
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 40px 20px;
      color: #333;
    }
    .invoice-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 40px;
      padding-bottom: 20px;
      border-bottom: 3px solid #4caf50;
    }
    .invoice-title {
      font-size: 32px;
      font-weight: bold;
      color: #4caf50;
      margin-bottom: 10px;
    }
    .section-title {
      font-weight: bold;
      font-size: 12px;
      color: #666;
      text-transform: uppercase;
      margin-bottom: 8px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }
    th {
      background: #f5f5f5;
      padding: 12px 8px;
      text-align: left;
      font-weight: 600;
      border-bottom: 2px solid #ddd;
    }
    .totals {
      margin-left: auto;
      width: 300px;
      margin-top: 20px;
    }
    .totals-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }
    .totals-row.final {
      border-bottom: none;
      border-top: 2px solid #333;
      font-size: 18px;
      font-weight: bold;
      padding-top: 12px;
    }
    .print-button {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 10px 20px;
      background: #4caf50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    .print-button:hover {
      background: #45a049;
    }
  </style>
</head>
<body>
  <button class="print-button no-print" onclick="window.print()">üñ®Ô∏è Print / Save as PDF</button>

  <div class="invoice-header">
    <div>
      <div class="invoice-title">${escapeHtml(myDetails.invoiceTitle || 'INVOICE')}</div>
      <div style="font-size: 14px; color: #666;">#${invoiceNumber}</div>
    </div>
    <div style="text-align: right;">
      <div style="font-weight: bold; font-size: 18px; margin-bottom: 5px;">${myDetails.name}</div>
      ${myDetails.taxId ? `<div style="font-size: 12px; color: #666; margin-bottom: 8px; font-weight: 500;">${escapeHtml(myDetails.taxIdLabel || 'Tax ID')}: ${escapeHtml(myDetails.taxId)}</div>` : ''}
      ${myDetails.email ? `<div><a href="${myEmailLink}" style="color: inherit; text-decoration: none;">${myDetails.email}</a></div>` : ''}
      ${myDetails.phone ? `<div>${myDetails.phone}</div>` : ''}
    </div>
  </div>

  <div style="display: flex; justify-content: space-between; margin-bottom: 40px;">
    <div>
      <div class="section-title">Bill To</div>
      <div style="font-weight: bold; font-size: 16px; margin-bottom: 8px;">${client.name}</div>
      ${client.email ? `<div style="font-size: 13px; color: #555;"><a href="${clientEmailLink}" style="color: inherit; text-decoration: none;">${client.email}</a></div>` : ''}
      ${client.address ? `<div style="margin-top: 8px; font-size: 13px; color: #555; white-space: pre-line;">${client.address}</div>` : ''}
    </div>
    <div style="text-align: right;">
      <div class="section-title">Invoice Details</div>
      <div><strong>Invoice Date:</strong> ${invoiceDate}</div>
      <div><strong>Period:</strong> ${periodLabel}</div>
    </div>
  </div>

  <table>
    <thead>
      <tr>
        <th>Description</th>
        <th style="width: 100px; text-align: right;">Hours</th>
        <th style="width: 100px; text-align: right;">Rate</th>
        <th style="width: 120px; text-align: right;">Amount</th>
      </tr>
    </thead>
    <tbody>
      ${lineItems}
    </tbody>
  </table>

  <div class="totals">
    <div class="totals-row">
      <span>Subtotal:</span>
      <span>$${subtotal.toFixed(2)}</span>
    </div>
    ${client.taxEnabled ? `
    <div class="totals-row">
      <span>${client.taxName} (${client.taxRate}%):</span>
      <span>$${taxAmount.toFixed(2)}</span>
    </div>` : ''}
    <div class="totals-row final">
      <span>Total:</span>
      <span>$${total.toFixed(2)}</span>
    </div>
  </div>

  ${myDetails.bankDetails ? `
  <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd;">
    <div class="section-title">Payment Details</div>
    <div style="white-space: pre-line; margin-top: 8px; font-size: 13px;">${myDetails.bankDetails}</div>
  </div>` : ''}

  <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; text-align: center; font-size: 13px; color: #666;">
    <div>${escapeHtml(myDetails.invoiceMessage || 'Thank you for your business!')}</div>
    ${myDetails.website ? `<div style="margin-top: 8px;"><a href="${websiteUrl}" target="_blank" rel="noopener noreferrer" style="color: inherit; text-decoration: none;">${myDetails.website}</a></div>` : ''}
  </div>
</body>
</html>`;

        // Show preview
        document.getElementById('invoice-preview').style.display = 'block';
        const container = document.getElementById('invoice-iframe-container');
        
        const invoiceData = {
          number: invoiceNumber,
          clientId: client.id,
          clientName: client.name,
          date: invoiceDate,
          period: periodLabel,
          total: total,
          createdAt: new Date().toISOString()
        };
        pendingInvoiceData = invoiceData;
        hasPendingInvoiceSaved = false;
        
        // Create iframe with the invoice
        const iframe = document.createElement('iframe');
        iframe.style.width = '100%';
        iframe.style.height = '800px';
        iframe.style.border = '1px solid #ddd';
        iframe.style.borderRadius = '4px';
        container.innerHTML = '';
        container.appendChild(iframe);
        
        iframe.onload = () => {
          iframe.contentDocument.write(invoiceHTML);
          iframe.contentDocument.close();

          if (iframe.contentWindow) {
            iframe.contentWindow.addEventListener('beforeprint', () => {
              finalizeInvoiceSave();
            });
          }
        };
        
        iframe.src = 'about:blank';

        PluginAPI.showSnack({
          msg: `Preview ready. Invoice #${invoiceNumber} will be saved when you print or save to PDF.`,
          type: 'SUCCESS'
        });
      }

      // Wait for PluginAPI to be ready
      function waitForPluginAPI() {
        return new Promise((resolve) => {
          if (typeof PluginAPI !== 'undefined') {
            resolve();
          } else {
            const checkInterval = setInterval(() => {
              if (typeof PluginAPI !== 'undefined') {
                clearInterval(checkInterval);
                resolve();
              }
            }, 100);
          }
        });
      }

      // Initialize on load
      waitForPluginAPI().then(() => {
        init();
      });
    </script>
  </body>
</html>